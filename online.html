<!DOCTYPE html>
<html>
	<head>
	<meta charset="UTF-8"/>
    <meta https-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0,user-scalable=no, initial-scale=1">
    <meta name = "format-detection" content = "telephone=no"><!--防止iOS网页中的数字被识别为电话号码-->
    <meta name="screen-orientation" content="portrait"><!-- uc强制竖屏 -->
    <meta name="x5-orientation" content="portrait"><!-- QQ强制竖屏 -->
	<title>金币大作战</title>
	<script src="https://i2.Yongche.name/s/js/201712/flexible.js?1478153218"></script>
	<style type="text/css">
* {margin: 0;padding: 0;box-sizing: border-box;}
html,body{width: 100%;height: 100%;position: relative;}
ul,li{list-style: none;}
input{ outline: none; border:none;-webkit-appearance: none;}
.wrapper{width: 100%;height: 100%;}
.mask{position: fixed; left: 0; top: 0; right: 0; bottom: 0; width: 100%; height: 100%; line-height: 0.67rem; font-size: 30px; background:rgba(0,0,0,0.4); display: none;}
.mask .container{ margin: 1.70rem auto 0; width: 7.76rem; height: 12.0rem; background: url(<{asset:media/g2/M02/1B/3C/rBEBJVpsgt6IVu3qAAA4m4S8h3AAAK3pwDtm3AAADiz299.jpg}>) ; border: 0.08rem solid #fcd315; border-radius: 0.2rem; position: relative; color: #eca205; font-size: 0.346667rem;}
.mask .container .mask-title{ width:3.933333rem; height: 1.133333rem; font-size: 0.64rem; line-height: 1.0rem; text-align: center; border-radius: 0.24rem; margin: -0.533333rem auto 0; background: #fdd65f; border: 0.08rem solid #fcd315; border-radius: 0.2rem; color: #FFFFFF; }
.mask .close_btn{ margin: 0.2rem auto; width:37px; height: 37px; background: url(<{asset:media/g2/M02/1B/3C/rBEBJVpsgt6IdibaAAAK4o2vF1QAAK3pwDnPOsAAAr6941.png}>) no-repeat; background-size: 100%;}
#rule .rule-contain{ line-height: 0.506667rem; padding: 0 0.506667rem 0 0.8rem;}
#rule .rule-contain ul{list-style:decimal;margin-top: 0.15rem;}
#rule .rule-contain .rule-item{margin-bottom: 0.266667rem;}

#prize .prize-contain .prizewrapper{height: 11.0rem;overflow: scroll;}
#prize .prize-contain .noprize{font-size: 0.6rem;text-align: center;line-height: 1.3rem; padding-top: 2rem;}
#prize .prize-contain .prizelist{display: none;}
#prize .prize-contain .prizeitem{margin:0.8rem auto;width:5.906667rem;height:1.946667rem;padding: 0.2rem 0 0 2.8rem;font-size: 0.28rem;}
#prize .prize-contain .prize95{background: url(<{asset:media/g2/M02/1C/02/rBEBP1pwO-2IL5IQAAAS2l_y62AAAK6DwP91GAAABLy197.png}>) no-repeat; background-size: 100% 100%;}
#prize .prize-contain .prize90{background: url(<{asset:media/g2/M01/1C/02/rBEBP1pwO-2IIFweAAAPzJjH1aIAAK6EgMPauAAAA_k547.png}>) no-repeat; background-size: 100% 100%; }
#prize .prize-contain .prize85{ background: url(<{asset:media/g2/M01/1C/02/rBEBJVpwO-yIfxG0AAATOlAQekEAAK6EgMPV44AABNS668.png}>) no-repeat; background-size: 100% 100%; }
#prize .prize-contain .prizeitem-owner{ display: inline-block; max-width: 1.5rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; vertical-align: top;}

#sharearrow .arrowbg{margin: 2.0rem auto; width: 8.0rem; height: 2.0rem; background: url(<{asset:media/g2/M04/1B/3F/rBEBJVpu1QuIGeKBAAAPO8ZBMjgAAK5AwP7dDcAAA9T083.png}>) no-repeat; background-size: 100%;}

.leadPage-mask{background: url(<{asset:media/g2/M02/1B/3C/rBEBJVpsgt6IRTWKAABMifFwiTgAAK3pwDtJqEAAEyh459.png}>); background-size: 100%;}
#close_leadPage{position: absolute; right: 0.8rem;top: 0.7rem;}

#over .over-contain .top-contain{
	margin-bottom: 0.69rem;
	height: 5.0rem;
	padding: 0.1px;
}
#over .over-contain .winer{
	display: none;
}
#over .over-contain .loser{
	font-size: 0.6rem;
    text-align: center;
    line-height: 1.3rem;
    padding: 1.3rem 0 0 0;
	display: none;
}
#over .over-contain .gongxi{ margin: 0.33333rem auto 0; width:6.693333rem; height: 2.36rem; background: url(<{asset:media/g2/M02/1B/3C/rBEBP1psgt2IRvRVAACt4ep_JkcAAK3pwDt4esAAK35479.jpg}>); background-size: 100%; }
#over .over-contain .discount{ margin: 0.53rem auto 0; width:6.666667rem; height:2.306667rem; padding:0.5rem 0 0 3.2rem; }
#over .over-contain  .discount95{ background: url(<{asset:media/g2/M02/1C/02/rBEBP1pwO-2IL5IQAAAS2l_y62AAAK6DwP91GAAABLy197.png}>) no-repeat; background-size: 100% 100%; }
#over .over-contain  .discount90{ background: url(<{asset:media/g2/M01/1C/02/rBEBP1pwO-2IIFweAAAPzJjH1aIAAK6EgMPauAAAA_k547.png}>) no-repeat; background-size: 100% 100%; }
#over .over-contain  .discount85{ background: url(<{asset:media/g2/M01/1C/02/rBEBJVpwO-yIfxG0AAATOlAQekEAAK6EgMPV44AABNS668.png}>) no-repeat; background-size: 100% 100%; }
#over .over-contain .line{ font-size: 0.453333rem; color: #a8a381; text-align: center; }
#over .over-contain  #totalscore{ font-size: 0.8rem; }
#over .over-contain .playagin{ margin: 0.5rem auto ; width:4.93rem; height:0.986667rem; border-radius: 0.49rem; text-align: center; line-height: 0.986rem; font-size: 0.40rem; color: #f5f5f5; background: #ff5b5b; }
#over .over-contain .noagin{ background: #CCCCCC; }
#over .over-contain  .sharetofriend{ margin: 0 auto; width:4.93rem; height:0.986rem; line-height: 0.986rem; text-align: center; font-size: 0.45rem; color: #ff5b5b; }

#loginMask .login-contain{ margin: 30% auto 0; width: 80%; height: auto; border-radius: 0.2rem; position: relative; color: #eca205; padding: 30px; background: #FFFFFF; }
.login-contain .login-title{ font-size: 22px; line-height: 54px; }		
.login-contain  .login-input{ margin-bottom: 12px; display: inline-block; width:95%; height:45px;  border:1px solid #ccc;  border-radius: 23px;  font-size: 16px; padding-left: 12px; }
.login-contain .login-input-short{ width:50%; display: inline-block; vertical-align: top; margin-right: 5px; }
.login-contain .login-code{ width:40%; height:45px; font-size: 16px; display: inline-block; }
.login-contain .login-getmsgcode{ color: #FFFFFF; background: #E92C2A;  border-radius: 23px; }
.login-contain .login-captchacode{ background: #CCCCCC; }
.login-contain .login-captchacode-wrapper{ display: none; }
.login-contain .login-btn{ width:95%; height:1.067rem; color: #FFFFFF; background: #E92C2A; border-radius: 0.5rem; font-size: 0.55rem; text-align: center; line-height: 1.067rem;}
/*错误提示吐司*/
.toast{ position: fixed; bottom : 35%; left: 10%; width: 80%; height: 40px; line-height: 40px; background: rgba(0,0,0,0.5); color: #fff; z-index: 30; text-align: center; border-radius: 10px;font-size: 16px;display: none;}			
	</style>
	</head>
	<body>
		<div>
			<div class="wrapper"> 
				<div id="game"></div>
			</div>
			<div id="rule" class="mask rule-mask">
				<div class="container rule-contain">
					<div class="mask-title">活动规则</div>
					<div class="prizewrapper">
						<ul>
							<li class="rule-item">每位用户第一次进入游戏时获得一次免费游戏机会； </li>
							<li class="rule-item">用户每打一次车，会获得一次游戏机会，邀请好友参加游戏后，双方各获得一次游戏机会，每个用户每天最多获得4次通过邀请得到的游戏机会，且每位用户只能在一天内被邀请一次；</li>
							<li class="rule-item">当游戏开始后，在60秒内，左右滑动汽车，每得到一个金币加100分，撞到障碍物游戏结束； </li>
							<li class="rule-item">游戏结束后，可根据所获得金币数所对应的积分获取奖励，所获奖品请在“我的奖品”页面查看； </li>
							<li class="rule-item">奖品对应积分为：3000分可获得——9.5折优惠券一张，5000分可获得——9折优惠券一张，7000分以上可获得——8.5折优惠券一张，所获优惠券可用于用车费的部分抵扣，优惠券使用规则请参见易到App个人中心优惠券页面。</li>
						</ul>
					</div>	
				</div>
				<div id="close_rule" class="close_btn"></div>
			</div>
			<div id="prize" class="mask prize-mask">
				<div class="container prize-contain">
					<div class="mask-title">我的奖品</div>
					<div class="prizewrapper">
						<ul class="prizelist">
						</ul>
						<div class="noprize">
						尚未获得奖品，<br/>
						赶快开始游戏吧
						</div>
					</div>
				</div>
				<div id="close_prize" class="close_btn"></div>
			</div>
			<div id="over" class="mask over-mask">
				<div class="container over-contain">
					<div class="mask-title">游戏结束</div>
					<div class="top-contain">
						<div class="winer"><!--恭喜获得-->
							<div class="gongxi"></div>
						</div>
						<div class="loser"><!--真遗憾-->
							<div class="loser1">真遗憾，</div>
							<div class="loser2">离奖励就差一点了</div>
						</div>
					</div>
					<div class="line totalscore">本次获得<span id="totalscore"></span>分</div>
					<div class="line defeat">击败<span id="defeat"></span>%用户</div>
					<div id="playagin" class="playagin ">再玩一次（剩余<span id="gameNum"></span>次）</div>
					<div id="sharetofriend" class="sharetofriend">邀好友来玩再得机会  &gt;</div>
				</div>
				<div id="close_over" class="close_btn"></div>
			</div>
			<div id="leadPage" class="mask leadPage-mask">
				<div id="close_leadPage" class="close_btn"></div>
			</div>
			<div id="sharearrow" class="mask">
				<div class="arrowbg"></div>
			</div>
			<div id="loginMask" class="mask login-mask">
				<div class=" login-contain">
		            <div class="login-title">手机号登录</div>
		            <input id="login-tel" type="tel" class="login-input" placeholder="请输入手机号" maxlength="11">
		            
		            <div class="login-captchacode-wrapper"> <!--图形验证码-->
		                <input id="login-captchacode" class="login-input login-input-short" type="text" placeholder="请输入验证码" maxlength="4">
		                <span class="login-code login-captchacode"><img  id="login-getcaptchacode" width="100%" height="100%" src="https://market.yongche.com/activity/Webuser/getCaptcha"></span>
		            </div>
		            <div>  <!--短信验证码-->
		                <input id="login-msgcode" class="login-input login-input-short" type="tel" placeholder="请输入验证码" maxlength="6">
		                <input id="login-getmsgcode" type="button" class="login-code login-getmsgcode" value="获取验证码">
		            </div>
		            <div id="login-btn" class="login-btn">登   录</div>
		        </div>
		        <div id="close_login" class="close_btn"></div>
	        </div>
			<div class="toast"></div>
		</div>
		
<script src="https://i3.Yongche.name/s/js/201801/myphaser2.6.min.js?1478153218"></script>
<script src="https://cdn.bootcss.com/jquery/3.1.0/jquery.min.js"></script>
<script src="//res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript"> //<!--分享相关及GA-->
//端内分享相
var Tools;
function ajaxShare(obj){
    // 分享变量设置
    var _protocolLink = "yongche://share?";
    var _protocolLinkFriend = "yongche://shareToFriend?";
    var _protocolLinkTimeline = "yongche://shareToTimeline?";
    // 分享地址
    var shareRead_link = encodeURIComponent(obj.url);
    // 分享的图片
    var shareRead_pics = encodeURIComponent(obj.shareimg);
    // 分享的标题
    var shareRead_title = encodeURIComponent(obj.title);
    // 分享的内容
    var shareRead_content = encodeURIComponent(obj.description);
    // 分享的需要生成二维码地址
    var shareRead_codeUrl = encodeURIComponent("://m.yongche.com");
    var shareRead_sourceType = 42; //1-截图分享 42-图文分享
    var shareRead_callback = "share_callback";

    Tools = {
        shareThisPage:function(){
            var _str = "link="+shareRead_link+"&pics="+shareRead_pics+"&title="+shareRead_title+"&content="+shareRead_content+"&sourceType="+shareRead_sourceType+"&callback="+shareRead_callback+"&codeUrl="+shareRead_codeUrl;
            var _tmpOpenLink = _protocolLink + _str;
            window.location.href = _tmpOpenLink;
        },
        shareThisPageToFriend:function(){
            var _str = "link="+shareRead_link+"&pics="+shareRead_pics+"&title="+shareRead_title+"&content="+shareRead_content+"&sourceType="+shareRead_sourceType+"&callback="+shareRead_callback+"&codeUrl="+shareRead_codeUrl;
            var _tmpOpenLink = _protocolLinkFriend + _str;
            window.location.href = _tmpOpenLink;
        },
        shareThisPageToTimeline:function(){
            var _str = "link="+shareRead_link+"&pics="+shareRead_pics+"&title="+shareRead_title+"&content="+shareRead_content+"&sourceType="+shareRead_sourceType+"&callback="+shareRead_callback+"&codeUrl="+shareRead_codeUrl;
            var _tmpOpenLink = _protocolLinkTimeline + _str;
            window.location.href = _tmppenLOink;
        }
    };
    var _str = "link="+shareRead_link+"&pics="+shareRead_pics+"&title="+shareRead_title+"&content="+shareRead_content+"&sourceType="+shareRead_sourceType+"&from=iframe&callback="+shareRead_callback;
    var _tmpOpenLink = _protocolLink + _str;
    //console.log(_tmpOpenLink);
}
	
//微信二次分享	       
(function ($) {
    $.fn.wxShare = function (oParam) {
        var shareImg = oParam.shareImg;
        var shareTitle = oParam.shareTitle;
        var shareContent = oParam.shareContent;
        var shareUrl = oParam.shareUrl;
        $.ajax({
            url:"//weixin.yongche.com/wechat/jssdk/config?url="+encodeURIComponent(window.location.href),
            method:'get',
            dataType:'jsonp'
        }).done(function(data){
            console.log(data);
            if(data.code==200){
                wx_share(data.result);
            }
        }).fail(function(error){
            //console.log(error)
        });
        function wx_share(jsData) {
            wx.config({
                debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                appId: jsData.appId, // 必填，公众号的唯一标识
                timestamp: jsData.timestamp, // 必填，生成签名的时间戳
                nonceStr: jsData.nonceStr, // 必填，生成签名的随机串
                signature: jsData.signature,// 必填，签名，见附录1
                jsApiList: ['onMenuShareAppMessage','onMenuShareTimeline','onMenuShareQQ','onMenuShareWeibo'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
            });
            wx.ready(function(){
                var shareData =
                    {
                        link:shareUrl,
                        imgUrl:shareImg,
                        title:shareTitle,
                        desc:shareContent,
                        type: '', // 分享类型,music、video或link，不填默认为link
                        dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
                        success: function () {
                            // 用户确认分享后执行的回调函数
                        },
                        cancel: function () {
                            // 用户取消分享后执行的回调函数
                        }
                    };
                wx.onMenuShareAppMessage(shareData);
                wx.onMenuShareTimeline(shareData);
                wx.onMenuShareQQ(shareData);
            });
        }
    }

    window.wxShareFn = function(oParam){
        $.fn.wxShare(oParam);
    }

})(jQuery);
	
//GA
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-18761483-4', 'auto');  ga('send', 'pageview');
  
</script>
<script type="text/javascript"> //<!--//DOM及接口请求-->
var gameNum = '- -', //游戏次数 -初始化值， 
	gameToken = '', //游戏token -初始值， 
	isLogin = false, //是否登录
	isRightTime = false, //是否在活动期间
	inApp = navigator.userAgent.indexOf("YongChe")<=0 ? false : true;
var shareToken1 = GetQueryString('shareToken');
var telInput = $('#login-tel'),   //手机号输入框
	msgInput = $('#login-msgcode'),   //短信验证码输入框
	captchaInput = $('#login-captchacode'),  //图片验证码输入框
	getmsgcodeBtn = $('#login-getmsgcode'),  //获取短线验证码按钮
	getcaptchaBtn = $('#login-getcaptchacode'),  //获取图片验证码
	loginBtn = 	$('#login-btn'),  //登录按钮
	need_imgcode = 0,
	cellphone,
	msgcode,
	captcha;

//document.cookie='_app_token_v3=XTDOwAJVYQ4fTB9z8QRo1jcuPrfkBBwPhlzs8j_79RU';    //16800120011
// kKtwZA2vYwxbJBA5P-eiivWuFrHLWLBF-ECli2a-5WA
var httpHead = 'https://testing-market.Yongche.org'; //线下接口
//var httpHead = 'https://market.yongche.com'; //线上接口

//活动规则页\我的奖励页\引导页\登录页---  “关闭按钮”
$(".close_btn").click(function(){
	$('.mask').fadeOut(300);
	console.log($(this));
	console.log($('#close_login'));
	console.log($(this)==$('#close_login'));
	
	if($(this)==$('#close_login')){ //TODO
		telInput.val('');
	    msgInput.val('');
	    captchaInput.val('');
	}
})


//“再玩一次”
$("#playagin").click(function(){
	if(gameNum<=0){
		toastMsg('分享可得游戏次数');
		return 
	}
	$('#over').hide();
	gameNum--;
	game.state.start('play');
	startGame();
	getCommon(1);
})

//结束页关闭返回首页
$('#close_over').click(function(){
	$('.mask').fadeOut(300);
	getCommon();
})

//端外分享箭头指引
$('#sharearrow').click(function(){
	$(this).hide();
})
//“分享给朋友”
$('#sharetofriend').click(shareFn);
function shareFn() {
	if(inApp){//端内分享
		ga('send', 'event', 'share_button', 'click', 'shareClickChristmas');
	    Tools.shareThisPage();
	}else{
		$('#sharearrow').show();
	}
} 

window.onresize = function(){
 //alert('change')
}

if(!inApp){//端wai分享
	wxShareFn({
		shareImg: 'http://i3.yongche.Name/media/g2/M03/1C/07/rBEBJVpy8iOIZZJkAACTrvpjzssAAK79AKaJ5sAAJPG404.png',
	    shareUrl: window.location.href,
		shareTitle: '快来参加易到金币大作战',
		shareContent: '参与游戏赢用车券啦'
	});
}

function getCommon(isagin){
	$.ajax({
        type:'get',
        url: httpHead + '/Miscellaneous/Activityusergame/getCommon',
        dataType:'jsonp',
        jsonp:'callback',
        xhrFields: {
            withCredentials: true
        },
        crossDomain: true,
        success:function(data) {
            //alert('getCommon'+data.code);
        	if(data.code==200){
        		isLogin = true;
        		isRightTime=true;
				gameNum = data.result.gameNum;
                if(!isagin){getMyPrizelist();}
                if(inApp){//端内
                	if(!isagin){
                		//端内分享配置
		                ajaxShare({
		                    url:'https://www.yongche.com/cms/page/glj.html?shareToken='+data.result.shareToken,
		                    shareimg:'http://i3.yongche.Name/media/g2/M03/1C/07/rBEBJVpy8iOIZZJkAACTrvpjzssAAK79AKaJ5sAAJPG404.png',
		                    title:'快来参加易到金币大作战',
		                    description:'参与游戏赢用车券啦'
		                })
                	}
                }else{//端外
                	if(shareToken1){//给他人助力
			       		helphimFn();
				    } else{
				        wxShareFn({
			           		shareImg: 'http://i3.yongche.Name/media/g2/M03/1C/07/rBEBJVpy8iOIZZJkAACTrvpjzssAAK79AKaJ5sAAJPG404.png',
				            shareUrl:'https://www.yongche.com/cms/page/glj.html?shareToken='+ data.result.shareToken,
							shareTitle: '快来参加易到金币大作战',
							shareContent: '参与游戏赢用车券啦'
			           	});
				    }
                }
            }else if(data.code==403){//未登录
            	isLogin = false;
            }else{//现在不在活动期间 || 用户信息为空
            	isLogin = true;
            	isRightTime=false;
            }
            if(!isagin){game.state.start('created');}
        },
        error:function(err){
           toastMsg(err.msg)
        }
	});
}
function getMyPrizelist(){
	$.ajax({
        type:'get',
        url: httpHead + '/Miscellaneous/Activityusergame/getAwardList',
        dataType:'jsonp',
        xhrFields: {
            withCredentials: true
        },
        crossDomain: true,
        success:function(data) {
            if(data.code==200){
            	isLogin = true;
                updateMyPrizelist(data.result);//更新我的奖品列表  
            }else {//未登录
                isLogin = false;
            }
        },
        error:function(err){
            console.log(err.msg)
        }
	});
}

function startGame(){//开始游戏
	$.ajax({
        type:'get',
        url: httpHead + '/Miscellaneous/Activityusergame/startGame',
        dataType:'jsonp',
        xhrFields: {
            withCredentials: true
        },
        crossDomain: true,
        success:function(data) {
            if(data.code==200){
            	isLogin = true;
				gameToken = data.result.gameToken;
				gameNum-=1;
				game.state.start('play');
            }else if(data.code==403) {//未登录
            	isLogin = false;
                toastMsg(data.msg);
            }else {
            	isLogin = true;
            	toastMsg(data.msg);
            }
        },
        error:function(err){
            console.log(err.msg)
        }
	});
}

function endGame(gameToken,goldNum){//游戏结束
	$.ajax({
        type:'get',
        url: httpHead + '/Miscellaneous/Activityusergame/endGame?gameToken='+gameToken+'&goldNum='+goldNum,
        dataType:'jsonp',
        xhrFields: {
            withCredentials: true
        },
        crossDomain: true,
        success:function(data) {
            if(data.code==200){
            	isLogin = true;
            	gameNum = data.result.gameNum;
				updateoverData(data.result)
            }else if(data.code==403) {//未登录
                toastMsg(data.msg);
                isLogin = false;
            }else {
            	toastMsg(data.msg);
            	isLogin = true;
            }
        },
        error:function(err){
            console.log(err.msg)
        }
	});
}

//点击登录按钮
loginBtn.click(function() {
    cellphone = telInput.val(),
	msgcode = msgInput.val(),
	captcha = captchaInput.val();
    if(!checkMobile(cellphone)){
        toastMsg('请输入正确手机号');
        return false;
    }
    if(need_imgcode==1 && !captcha){
        toastMsg('请输入图形验证码');
        return false;
    }
    if(!msgcode){
        toastMsg('请输入短信验证码');
        return false;
    }
    $.ajax({
        url: httpHead + '/activity/Webuser/Login?cellphone='+cellphone+'&code='+msgcode+'&captcha='+captcha,
        type:'get',
        dataType:'jsonp',
        xhrFields: {
            withCredentials: true
        },
        crossDomain: true,
        success:function(data) {
            //alert('Login'+data.code);
            if(data.code==200){//登录成功
				$('#loginMask').hide();
				isLogin = true;
                if(shareToken1){
			        helphimFn();
			    } else{
			        getCommon();
			    }
            }else{
            	isLogin = false ;
                toastMsg(data.msg);
            }
            
        },
        error:function(err){
            console.log(data.msg)
        }
    })
});

function helphimFn() { //助力
    $.ajax({
        url: httpHead + '/Miscellaneous/Activityusergame/helpUser?shareToken=' +shareToken1,
        type:'get',
        dataType:'jsonp',
        xhrFields: {
            withCredentials: true
        },
        crossDomain: true,
        success:function(data) {
        	//alert('help'+data.code);
        	if(data.code==403) {//未登录
                toastMsg(data.msg);
                isLogin = false;
            }else if(data.code==504||data.code==500){
            	isLogin = true ;
            	toastMsg(data.msg);
            }else{
            	isLogin = true ;
            	gameNum = data.result.gameNum;
	            game.state.start('created');
	            getMyPrizelist();
	            toastMsg(data.msg);
	            //微信二次分享 //TODO
	           	wxShareFn({
	           		shareImg : 'http://i3.yongche.Name/media/g2/M03/1C/07/rBEBJVpy8iOIZZJkAACTrvpjzssAAK79AKaJ5sAAJPG404.png',
					shareTitle : '快来参加易到金币大作战',
					shareContent : '参与游戏赢用车券啦',
		            shareUrl : 'https://www.yongche.com/cms/page/glj.html?shareToken='+ data.result.shareToken
	           	});
            }
        	game.state.start('created');
        },
        error:function(err){
            console.log(err.msg);
        }
    });
}
        
getmsgcodeBtn.click(function () {//获取短信验证码
    cellphone = telInput.val();
    captcha = captchaInput.val();
    var isverify = checkMobile(cellphone);//检测手机号是否合法
    if(!isverify){
        toastMsg('请输入正确的手机号');
        return false;
    }
    console.log(need_imgcode);
    if(need_imgcode == 1){//需要图形验证码
        console.log(captcha);
        if(!captcha){
            toastMsg('请输入图形验证码');
            return false;
        }
        getMsgCode(cellphone,captcha);
    }else{
    	getMsgCode(cellphone,captcha);
    }
})

function getMsgCode(cellphone,captcha) {//获取短信验证码接口
    $.ajax({
        type:'get',
        url:httpHead+'/activity/Webuser/getCode?cellphone='+cellphone+'&captcha='+captcha,
        dataType:'jsonp',
        xhrFields: {
            withCredentials: true
        },
        crossDomain: true,
        success:function(data) {
            //alert('getMsgCode'+data.code);
            if(data.code==401){//请输入图片验证码
                need_imgcode = 1;
                $(".login-captchacode-wrapper").show();
            } else if(data.code == 200){
                var count = 59;
                var countdown = setInterval(CountDown, 1000);
                function CountDown() {
                    getmsgcodeBtn.attr("disabled", true);
                    getmsgcodeBtn.css("background","#999");
                    getmsgcodeBtn.val(count + "s");
                    if (count == 0) {
                        getmsgcodeBtn.val("获取验证码").removeAttr("disabled");
                        getmsgcodeBtn.css("background","#E92C2A");
                        clearInterval(countdown);
                    }
                    count--;
                }
            } else if(data.code == 429) {
                if(need_imgcode==1){
                    getcaptchaFn();
                }
                toastMsg('请求次数过多,请稍后重试')
            } else if(data.code == 400){
                toastMsg('图形验证码错误');
                if(data.isUpdate == 1){
                    getcaptchaFn();
                }
            } else if(data.code == 449) {
                toastMsg('请求太频繁');
                if(need_imgcode==1){
                    getcaptchaFn();
                }
            }
        },
        error:function(err){
            console.log(err.msg)
        }
    })
}

getcaptchaBtn.click(getcaptchaFn);
function getcaptchaFn() {//获取图形验证码
    getcaptchaBtn.attr('src',httpHead+'/activity/Webuser/getCaptcha?t='+new Date().getTime());
}

function GetQueryString(name) {
    var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
    var r = window.location.search.substr(1).match(reg);
    if(r!=null)return  unescape(r[2]); return null;
}

function checkMobile(number){//检查手机号
	var res = /^1(3[0-9]|4[57]|5[0-35-9]|7[0135678]|8[0-9]|6[8])\d{8}$/.test(number);
	return res ? true :false;
}

//over页面展示
function showOver(score){
	$('#over').show();
	endGame(gameToken,score);//把金币数数传给后台
}
function updateoverData(data){
	$('.winer').children('.discount').remove();
	$('#totalscore').text(data.goldNum); //游戏总分
	$('#defeat').text(data.defeat); //击败多少人
	$('#gameNum').text(data.gameNum);//游戏次数
	if(data.gameNum<=0){
		$('.playagin').addClass('noagin');
	}
	if(data.awardId==''){//优惠券等级
		$('.winer').hide()
		$('.loser').show();
	}else{
		$('.loser').hide();
		var levelclass = '';
		if(data.awardId===4874){
			levelclass = 'discount95';
		}else if(data.awardId===5138 ){
			levelclass = 'discount90';
		}else if(data.awardId===5136){
			levelclass = 'discount85';
		}
		var str = '<div class="discount '+ levelclass +' "></div>';
		$('.winer').append($(str)).show();
	}
}

function updateMyPrizelist(prizelist){
	var str = '', levelclass = '';
	if(prizelist.length<=0){
		$('.prizelist').hide();
		$('.noprize').show();
		return;
	}
	$('.noprize').hide();
	$('.prizelist').children('.prizeitem').remove();
	prizelist.forEach(function(item){
		if(item.awardId==4874){
			levelclass = 'prize95';
		}else if(item.awardId==5138){
			levelclass = 'prize90';
		}else if(item.awardId===5136){
			levelclass = 'prize85';
		}
		str += '<li class="prizeitem '+ levelclass +'"></li>';
	})
	$('.prizelist').append($(str)).show();
}

function toastMsg(msg){
	$('.toast').fadeIn(100).text(msg);
	setTimeout(function(){
		$('.toast').fadeOut(100)
	},2000)
}

</script>	
<script type="text/javascript"> //<!--//游戏逻辑-->	
//点击屏幕任意位置，可拖动主角
//生成障碍和金币的方法合二为一
var width = window.innerWidth;  
var height = window.innerHeight; 
var httpimg = 'https://www.yongche.com/media/get_image.php?media_id='; 
//var httpimg = 'https://i1-testing.Yongche.org/media/';
var httpaudio = '//i0.yongche.name/';
var spicJson = {"frames":[{"filename":"coinbg","frame":{"x":2,"y":246,"w":225,"h":82},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":225,"h":82},"sourceSize":{"w":225,"h":82}},{"filename":"crash","frame":{"x":310,"y":514,"w":186,"h":153},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":186,"h":153},"sourceSize":{"w":186,"h":153}},{"filename":"garbagecan","frame":{"x":342,"y":404,"w":148,"h":108},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":29,"w":148,"h":108},"sourceSize":{"w":162,"h":162}},{"filename":"myprizebtn","frame":{"x":210,"y":382,"w":130,"h":95},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":130,"h":95},"sourceSize":{"w":130,"h":95}},{"filename":"one","frame":{"x":210,"y":579,"w":84,"h":290},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":62,"y":4,"w":84,"h":290},"sourceSize":{"w":208,"h":298}},{"filename":"playcount","frame":{"x":210,"y":479,"w":98,"h":98},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":98,"h":98},"sourceSize":{"w":98,"h":98}},{"filename":"plus100","frame":{"x":2,"y":871,"w":45,"h":13},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":45,"h":13},"sourceSize":{"w":45,"h":13}},{"filename":"roadblock","frame":{"x":229,"y":250,"w":104,"h":130},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":29,"y":15,"w":104,"h":130},"sourceSize":{"w":162,"h":162}},{"filename":"rulesbtn","frame":{"x":229,"y":162,"w":117,"h":86},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":117,"h":86},"sourceSize":{"w":117,"h":86}},{"filename":"sharebtn","frame":{"x":2,"y":82,"w":346,"h":78},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":346,"h":78},"sourceSize":{"w":346,"h":78}},{"filename":"startbtn","frame":{"x":2,"y":2,"w":346,"h":78},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":346,"h":78},"sourceSize":{"w":346,"h":78}},{"filename":"stone","frame":{"x":350,"y":2,"w":160,"h":100},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":32,"w":160,"h":100},"sourceSize":{"w":162,"h":162}},{"filename":"three","frame":{"x":350,"y":104,"w":158,"h":298},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":24,"y":0,"w":158,"h":298},"sourceSize":{"w":208,"h":298}},{"filename":"timerbg","frame":{"x":2,"y":162,"w":225,"h":82},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":225,"h":82},"sourceSize":{"w":225,"h":82}},{"filename":"two","frame":{"x":2,"y":330,"w":206,"h":298},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":206,"h":298},"sourceSize":{"w":208,"h":298}}],"meta":{"app":"http://www.texturepacker.com","version":"1.0","image":"spic.png","format":"RGBA8888","size":{"w":512,"h":1024},"scale":"1","smartupdate":"$TexturePacker:SmartUpdate:e9fd54ef0410952a79f755f7ac852be3$"}}

// 创建游戏实例
var game = new Phaser.Game(width, height, Phaser.CANVAS, 'game',true);
game.resolution = window.devicePixelRatio;
// 定义场景
var states = {
	// boot场景
	boot: function(){
		this.preload = function(){
			// 加载游戏资源
			game.load.image('loadingbg', httpimg+'g2/M02/1B/3C/rBEBP1psgt2IQiGTAAAoFpSO9-sAAK3pwDtc0IAACgu105.png');
	        game.load.image('loadingbar', httpimg+'g2/M02/1A/29/rBEBP1psgt2IFDjJAAADk5OHafEAAKXpgP__FUAAAOr234.png');
		},
		this.create = function(){
			//game.add.image(0,0,'loadingbg');
		},
		this.render = function(){
			game.state.start('preload');
		}
	},
	// 加载场景
    preload: function() {
    	this.preload = function() {
	        var loadingbg = game.add.sprite(game.world.centerX,game.world.centerY,"loadingbg");
	        var loadingbar = game.add.sprite(0,0,"loadingbar");
	        loadingbar.reset(game.world.centerX-loadingbar.width/2,game.world.centerY);
	        loadingbg.anchor.setTo(0.5, 0.5);
	        loadingbar.anchor.setTo(0, -1.05);
	        game.load.setPreloadSprite(loadingbar);
	        // 加载游戏资源
	        game.load.image('homepagebg', httpimg+'g2/M01/1C/04/rBEBP1pxgyeIE05HAAXMI327Te4AAK7DwCSJ8AABcw7461.png');//首页-背景
	        game.load.image('playbg', httpimg+'g2/M02/1C/0A/rBEBP1p1bO6INpQfAAyHmwBz6oQAAK9VwGfhwwADIez518.png');//游戏页-背景
	        game.load.atlas("spic", httpimg+"g2/M02/1C/0B/rBEBP1p1kY6ICQlTAAHlhv6pJOQAAK9dwHKeuoAAeWe249.png", null,spicJson);//精灵图
	        game.load.spritesheet('dude', httpimg+'g2/M04/1C/0A/rBEBP1p1XeaINgTsAAQ_1WywasIAAK9SgIGR0QABD_t853.png',  187, 299); //游戏页-游戏主角
	        game.load.spritesheet('coin', httpimg+'g2/M02/1B/3C/rBEBP1psgt2IIJy2AAA9w4g5HbIAAK3pwDnR-UAAD3b307.png', 81, 81); //游戏页-金币
	        game.load.spritesheet('mute-play', httpimg+'g2/M02/1B/3C/rBEBJVpsgt6IVvREAAANsPV9iJMAAK3pwDt1CMAAA3I754.png', 32, 23); //游戏页-静音及播放
            game.load.crossOrigin = 'anonymous'; // 设置跨域
            game.load.audio('bgMusic', httpaudio+'s/download/201801/bgMusic1.mp3?1478153218');  //游戏页-背景音乐
	        game.load.audio('scoreMusic', httpaudio+'s/download/201801/addscore.mp3?1478153218');  //游戏页-加分音乐
            game.load.audio('bombMusic', httpaudio+'s/download/201801/bombom.mp3?1478153218');  //游戏页-爆炸音乐
            
            // 监听加载完毕事件
            game.load.onLoadComplete.add(onLoad);
            // 加载完毕回调方法
            function onLoad() {
            	getCommon(); 
            }
	    }
    },
    // 开始场景
    created: function() {
    	var button,muteButton;
    	this.create = function() {
    		//alert('create')
    		// 声音管理类 
    		this.soundManager = game.sound;
            // 添加背景
	        var bg = game.add.image(0, 0, 'homepagebg');
	        bg.width = game.world.width;
	        bg.height = game.world.height;
	        // 添加"活动规则"按钮
	        ruleButton = game.add.button(game.world.width -60-9 , 20,'spic',  showRules, this, 'rulesbtn','rulesbtn', 'rulesbtn');
	        ruleButton.width /=2;
	        ruleButton.height/=2;
	        function showRules(){
	        	$('#rule').fadeIn(100);
	        }
	        // 添加"我的奖品"按钮
	        prizeButton = game.add.button(16, 16,'spic', showPrizes, this, 'myprizebtn', 'myprizebtn', 'myprizebtn');
	        prizeButton.width/=2;
	        prizeButton.height/=2;
	        function showPrizes(){
	        	if(!isLogin){//未登录--我的奖品、开始游戏 、分享，提示登录；游戏次数为'--'
	        		if(inApp){  
                		var link = 'yongche://login?done=' + encodeURIComponent(window.location.href);
                    	window.location.href = link;
	                }else{
	                	$('#loginMask').show();
	                }
	        		return 
	        	}
	        	$('#prize').fadeIn(100);
	        }
	        if(isLogin){//未登录
        		// 添加"我有几次游戏机会"
	            var gamecountText = game.add.text(game.world.centerX, game.world.height-140, '我有'+ gameNum +'次游戏机会', { fontSize: '18px', fill: '#FFFFFF' });
	            gamecountText.anchor.setTo(0.5, 1);
        	}
	       	
	        // 添加"开始游戏"按钮
	        startButton = game.add.button(game.world.centerX, game.world.height-90, 'spic', onStart, this,'startbtn','startbtn','startbtn');
	        startButton.width/=2;
	        startButton.height/=2;
	        startButton.anchor.setTo(0.5, 1);
	        function onStart(){
	        	if(!isLogin){//未登录
	        		if(inApp){
                		var link = 'yongche://login?done=' + encodeURIComponent(window.location.href);
                    	window.location.href = link;
	                }else{
	                	$('#loginMask').show();
	                }
	        		return 
	        	}
	        	if(!isRightTime){//现在不在活动期间 || 用户信息为空
	        		toastMsg('现在不在活动期间 或 用户信息为空');
	        		return
	        	}
	        	if(gameNum<=0){
	        		toastMsg('分享可获得游戏机会');
	        		return
	        	}
	        	startGame(); 
	        }
	        // 添加"分享 "按钮
	        shareButton = game.add.button(game.world.centerX, game.world.height-35, 'spic', onShare, this, 'sharebtn', 'sharebtn', 'sharebtn');
	        shareButton.width/=2;
	        shareButton.height/=2;
	        shareButton.anchor.setTo(0.5, 1);
	        function onShare(){
	        	if(!isLogin){//未登录
	        		if(inApp){
                		var link = 'yongche://login?done=' + encodeURIComponent(window.location.href);
                    	window.location.href = link;
	                }else{
	                	$('#loginMask').show();
	                }
	        		return 
	        	}
	            shareFn();
	        }
	        
	        // 添加静音按钮  播放
	        muteButton = game.add.button(game.world.width-32-14, game.world.height-23-14, 'mute-play', onMute, this, 1, 1, 1);
	        this.judgeMute();
	        muteButton.anchor.setTo(0.5, 0.5);
	        function onMute(){
	        	this.soundManager.mute =  !this.soundManager.mute;
	        	this.judgeMute();
	        }
       },
        this.judgeMute = function(update){
	    	if(update){
	    		if(this.soundManager.mute){
	        		muteButton.angle = 0;
	        	}else{
	        		muteButton.angle += 1;
	        	}
	    	}else{
	    		if(this.soundManager.mute){
	        		muteButton.setFrames(0, 0,0);
	        	}else{
	        		muteButton.setFrames(1, 1,1);
	        	}
	    	}
        }
    },
    // 游戏场景
    play: function() {
    	var grassBeltWidth = 40,
    		scoreMusic,
        	bombMusic,
        	bgMusic,
        	muteButton, 
        	preX = 0,
        	move_velocity = 200, // 障碍物和奖励的速度
        	minTouchDis = width/8,  // x滑动的最小触发距离
        	obstaclesTypes = ['stone','roadblock','garbagecan'];
    	this.create = function(){
    		this.touching = false; // 是否正在触摸
       		this.isAllStop=false;
    		// 声音管理类 
    		this.soundManager = game.sound;
    		// 添加背景音乐
            if (!bgMusic) {
                bgMusic = game.add.audio('bgMusic');
                bgMusic.loopFull();
            }
            // 缓存其他音乐
            scoreMusic = game.add.audio('scoreMusic');
            bombMusic = game.add.audio('bombMusic');
    		// 添加背景 无限滚动
	       	this.bg = game.add.tileSprite(0, 0, game.world.width, game.world.height, 'playbg'); 
	        game.physics.enable(this.bg, Phaser.Physics.ARCADE); 
	        // 滚动背景的像素宽高
	        this.bgImg = game.cache.getImage('playbg');
	        this.bg.tileScale.x = game.world.width / this.bgImg.width;
	        this.bg.tileScale.y = game.world.height / this.bgImg.height;
	    	//添加主角
	        this.car = this.game.add.sprite(game.world.centerX, game.world.height - 100, 'dude');
	        this.car.width = 99;
          	this.car.height= 157.5;
	        this.car.anchor.setTo(0.5, 0.5);
	        game.physics.arcade.enable(this.car);
          	this.car.body.setSize(123,210,32,13);   
	        // 创建动画
	  		this.car.animations.add('left', [4], 10, true);
	    	this.car.animations.add('center', [0,1,2,3], 10, true);
	  		this.car.animations.add('right', [5], 10, true);
	  		this.car.animations.add('over', [6], 10, true);
	  		this.car.animations.play('center');
	        // 创建一个group，包含coin  stone  roadblock  garbagecan
	        this.obstacles = game.add.group();
	        this.obstacles.enableBody = true;
	       	// 添加时间背景
	        var timerbg = game.add.image(19, 16,'spic', 'timerbg');
	        timerbg.width /=2;
	        timerbg.height /=2;
	        // 添加时间
			this.remainTime = 60;
	        var style = { font: "20px Arial", fill: "#ffffff" };
	        this.remainTimeText = this.game.add.text(62, 25, "01：00", style);
			// 添加次数背景
	        var countbg = game.add.image(game.world.centerX, 42, 'spic','playcount');
	        countbg.width /=2;
	        countbg.height /=2;
	        countbg.anchor.setTo(0.5, 0.5);
	        // 添加次数
	        var style = { font: "22px Arial", fill: "#ffffff" };
	        this.remainCountText = this.game.add.text(game.world.centerX, 42, gameNum, style);
	        this.remainCountText.anchor.setTo(0.5, 0.5);
			// 添加分数背景
	        var coinbg = game.add.image(game.world.width-19-112, 16, 'spic','coinbg');
	        coinbg.width /=2;
	        coinbg.height /=2;
	        // 添加分数和金币数
			this.score = 0;
	        var style = { font: "20px Arial", fill: "#ffffff" };
	        this.scoreText = this.game.add.text(game.world.width-19-90, 25, " "+this.score, style);
	        // 添加静音按钮  播放
	        muteButton = game.add.button(game.world.width-32-14, game.world.height-23-14, 'mute-play', onMute, this, 1, 1, 1);
	        this.judgeMute();
	        muteButton.anchor.setTo(0.5, 0.5);
	        function onMute(){
	        	this.soundManager.mute =  !this.soundManager.mute;
	        	this.judgeMute();
	        }
			// 监听滑动事件
			this.game.input.addMoveCallback(this.moveCallback,this);
			// 监听按下事件
			game.input.onDown.add(this.onDownCb,this);
			// 监听离开事件
			this.game.input.onUp.add(this.onUpCb,this);
			//第一次游戏展示引导页
			var that = this;
			var firstplay = window.localStorage.getItem("firstplay");
			if(!firstplay){
				$('#leadPage').fadeIn(100);
				firstplay = window.localStorage.setItem("firstplay",true);
			}else {
				this.ThreeTwoOne();//321开始倒计时
			}
			$("#close_leadPage").click(function(){
				$('#leadPage').fadeOut(100);
				that.ThreeTwoOne();//321开始倒计时
			})
    	},
    	this.update = function(){
    		this.judgeMute(1);
    		// 小车和障碍物的碰撞监听
    		game.physics.arcade.overlap(this.car, this.obstacles, this.crashCarFunc, null, this);
    	},
    	/*this.render = function() {
		    game.debug.bodyInfo(this.car, 32, 32);// 在坐标（32，32）位置显示文本debug信息
		    game.debug.body(this.car);// 绘制矩形body
		    this.obstacles.forEach(function(item){
		    	game.debug.body(item);// 绘制矩形body
		    })
		},*/
    	this.moveCallback = function(pointer, x, y, isTap) {
			if (isTap || !touching) return
			if(preX<x){//右划
				this.car.animations.play('right');
			}else if(preX==x){
				this.car.animations.play('center');
			}else if(preX>x){//向左
				this.car.animations.play('left');
			}
			preX = x;
			if( x <= grassBeltWidth + this.car.width/2){
				this.car.x =  grassBeltWidth + this.car.width/2;
			}else if(x >= (game.world.width - grassBeltWidth - this.car.width/2)){
				this.car.x = game.world.width - grassBeltWidth - this.car.width/2;
			}else{
				this.car.x = x;
			}
		},
		this.onDownCb = function(pointer) {
			touching = true;
		},
		this.onUpCb = function(pointer) {
			touching = false;
			if(this.isAllStop){
				return
			}
			this.car.animations.play('center');
		},
	    this.ThreeTwoOne = function(numImg){
	    	var num =3;
	    	var imgArr = ['one','two','three'];
	    	var ThreeTwoOneTimer = game.time.events.loop(1000,function(){
	    		if(num<=0){
	    			game.time.events.remove(ThreeTwoOneTimer)
	    			// 定时器，倒计时
		        	this.reduceTimer = game.time.events.loop(500, this.timerCallback, this); 
	    			return
	    		}
	    		this.tweenImg(imgArr[num-1]);
	    		num--;
	    	},this)
	    },
	    this.tweenImg = function(numImg){
	    	// 添加3,2,1图片
		    var goal = game.add.image(game.world.centerX, game.world.centerY,'spic', numImg);
		    goal.width = 0;
		    goal.height = 0;
		    goal.anchor.setTo(0.5,0.5);
		    goal.alpha = 0;
		    // 添加过渡效果
		    var showTween = game.add.tween(goal).to({
		        alpha: 1,
		        width : game.world.width/3,
		    	height : game.world.width/3
		    }, 200, Phaser.Easing.Linear.None, true, 0, 0, false);
		    showTween.onComplete.add(function() {
		        var hideTween = game.add.tween(goal).to({
		            alpha: 0,
		            width : 0,
		    		height : 0
		        }, 200, Phaser.Easing.Linear.None, true, 200, 0, false);
		    });
	    },
	   	this.judgeMute = function(update){
	    	if(update){
	    		if(this.soundManager.mute){
	        		muteButton.angle = 0;
	        	}else{
	        		muteButton.angle += 1;
	        	}
	    	}else{
	    		if(this.soundManager.mute){
	        		muteButton.setFrames(0, 0,0);
	        	}else{
	        		muteButton.setFrames(1, 1,1);
	        	}
	    	}
        },
	    this.add_move_sprite = function(){
	    	var starNum = Math.floor(Math.random()*10);
	    	//console.log(starNum)
	    	if(starNum <= 3){
	    		this.addmystones('coin',1);
	    	}else if(starNum <= 5){
	    		this.addmystones('coin',2);
	    	}else if(starNum <= 6){
	    		this.addmystones('stone',1);
	    	}else if(starNum <= 8){
	    		this.addmystones('roadblock',1);
	    	}else{
	    		this.addmystones('garbagecan',1);
	    	}
	    },
	    this.addmystones = function(type,n){
	    	// 随机[0,2]的整数,确定下落的跑道
		    var num = Math.floor(Math.random()*3);
		    var	halfRoadWidth = (game.world.width-grassBeltWidth*2)/6;
	    	for(var i=0;i<n;i++){
	        	var obstacle;
	        	var y;
	        	if(type==='coin'){
	        		obstacle = this.obstacles.create(0, 0, type);
		        	// 创建动画
			    	obstacle.animations.add('jump', [0, 1,2,3], 8, true);
			  		obstacle.animations.play('jump');
			  		y = (70)*(n-i-1);
			  		obstacle.body.setSize(63,50,10,5);
		        }else{
		        	obstacle = this.obstacles.create(0, 0,'spic', type);
		        	y = 0;
		        	obstacle.body.setSize(140,130,10,10);
		        }
		        var x = grassBeltWidth+ halfRoadWidth*(num*2+1);
		  		// 重新设置位置
		        obstacle.reset(x, y);
		  		obstacle.type = type;
		  		obstacle.width = 70;
	        	obstacle.height= 70;
	        	obstacle.anchor.setTo(0.5, 0.5);
	        	// kill超出边界的障碍物
		        obstacle.checkWorldBounds = true;
		        obstacle.outOfBoundsKill = true;
			}
       	},
	    this.timerCallback = function(){
	    	this.add_move_sprite();
	    	this.reduceTime();
	    },
	    this.reduceTime = function(){
	    	this.remainTime -= 0.5;
	    	var timeStr = parseInt(this.remainTime)<10 ? '0'+parseInt(this.remainTime) : parseInt(this.remainTime);
	        this.remainTimeText.text = "00: "+timeStr;
	        //随着时间进行，速度越来越快
	        var v = move_velocity + (60-this.remainTime)*20;
	        this.bg.autoScroll(0, v/(game.world.height / this.bgImg.height));
	        	this.obstacles.setAll('body.velocity.y',v,true,true);
	        
	        // 结束场景
	        if(this.remainTime <= 0){ 
	        	this.allStopMove();
	        	// 设置背景静止
	    		this.bg.autoScroll(0, 0);
		    	var that = this;
	        	game.time.events.add(1000, function(){
	        		showOver(parseInt(that.score/100));//展示“游戏结束”，并把分数发送给后台 
	        	}, this);
	        }
	    },
	    this.allStopMove = function(){
	    	// 移除定时器
        	this.game.time.events.remove(this.reduceTimer);
        	//让星星和障碍停止运动
	    	this.obstacles.setAll('body.velocity.y',0,true,true);
	    	this.isAllStop = true;
	    	//取消滑动监听，主角不可移动
	    	this.game.input.deleteMoveCallback(this.moveCallback,this);
	    },
	    this.crashCarFunc = function(car, obstacle){
	    	obstacle.kill();
	    	var imageName = '';
	    	if(obstacle.type==='coin'){
	    		imageName = 'plus100';
	    		// 更新分数
			   	this.score += 1*100;
	        	this.scoreText.text =  this.score; 
			    // 播放音效
	    		scoreMusic.play();
	    	}else{
	    		// 设置背景静止
	    		this.bg.autoScroll(0, 0);
	    		this.car.animations.play('over');
	    		imageName = 'crash';
	    		this.allStopMove();
	    		// 播放音效 
	    		bombMusic.play();  
	    	}
	    	
	    	// 添加得分或碰撞图片
		    var goal = game.add.image(obstacle.x, obstacle.y,'spic', imageName);
		    goal.anchor.setTo(0.5, 0.5);
		    goal.alpha = 0;
		    // 添加过渡效果
		    var showTween = game.add.tween(goal).to({
		        alpha: 1,
		        y: goal.y - 20
		    }, 100, Phaser.Easing.Linear.None, true, 0, 0, false);
		    var that = this;
		    showTween.onComplete.add(function() {
		        var hideTween = game.add.tween(goal).to({
		            alpha: 0,
		            y: goal.y - 20
		        }, 100, Phaser.Easing.Linear.None, true, 200, 0, false);
		        hideTween.onComplete.add(function() {
		            goal.kill();
		            if(obstacle.type==='coin') return
		            game.time.events.add(1000, function(){
		        		showOver(parseInt(that.score/100));//展示“游戏结束”，并把分数发送给后台 
		        	}, this);
		        });
		    });
	    }
    }
};

// 添加场景到游戏示例中
Object.keys(states).map(function(key) {
	game.state.add(key, states[key]);
});

// 启动游戏
game.state.start('boot');
</script>
	</body>
</html>

 